# docker/Dockerfile
FROM ubuntu:22.04

RUN apt-get update && apt-get install -y \
    bash \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Создаем скрипт напрямую в контейнере (избегаем проблем с форматом строк)
RUN echo '#!/bin/bash\n\
\n\
safe_exec() {\n\
    local cmd="$1"\n\
    local timeout=${2:-30}\n\
    \n\
    local forbidden_commands=(\n\
        "rm -rf /"\n\
        "rm -rf /*"\n\
        ":(){:|:&};:"\n\
        "mkfs"\n\
        "dd if=/dev/zero"\n\
        "chmod -R 777 /"\n\
        "shutdown"\n\
        "reboot"\n\
        "halt"\n\
        "poweroff"\n\
    )\n\
    \n\
    for forbidden in "${forbidden_commands[@]}"; do\n\
        if [[ "$cmd" == *"$forbidden"* ]]; then\n\
            echo "ERROR: Command not allowed for security reasons"\n\
            exit 1\n\
        fi\n\
    done\n\
    \n\
    timeout $timeout bash -c "$cmd" 2>&1\n\
    local exit_code=$?\n\
    \n\
    if [ $exit_code -eq 124 ]; then\n\
        echo "ERROR: Command timed out after $timeout seconds"\n\
    elif [ $exit_code -ne 0 ]; then\n\
        echo "ERROR: Command failed with exit code $exit_code"\n\
    fi\n\
    \n\
    return $exit_code\n\
}\n\
\n\
if [ $# -eq 0 ]; then\n\
    echo "Usage: $0 <command> [timeout]"\n\
    exit 1\n\
fi\n\
\n\
command="$1"\n\
timeout=${2:-30}\n\
\n\
safe_exec "$command" $timeout' > /app/run_command.sh

RUN chmod +x /app/run_command.sh

RUN useradd -m appuser
USER appuser

CMD ["tail", "-f", "/dev/null"]